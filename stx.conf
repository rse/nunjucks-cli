##
##  nunjucks -- Nunjucks Template Rendering Command-Line Interface
##  Copyright (c) 2019-2025 Dr. Ralf S. Engelschall <rse@engelschall.com>
##  Licensed under MIT <https://spdx.org/licenses/MIT>
##

#   static code analysis
lint
    eslint --config eslint.mjs nunjucks.ts && \
    tsc --noEmit --project tsconfig.json

#   build JavaScript from TypeScript
build
    vite --config vite.mts build --mode production &&
    remark --quiet --use remark-man --output dst-stage1/nunjucks.man nunjucks.md

#   execute simple smole test
test : build
    echo 'Hello, {{who}}!' | node nunjucks.js -D who=world -

#   package distribution archives
package : package:docker package:sea [hostname=en4.*]

#   package as Docker container image
package:docker [hostname=en4.*]
	IMAGE_PREFIX=`egrep "ARG.*IMAGE_PREFIX" Dockerfile | sed -e 's;^.*=;;' | head -1` && \
	IMAGE_NAME=`egrep "ARG.*IMAGE_NAME" Dockerfile | sed -e 's;^.*=;;' | head -1` && \
	IMAGE_VERSION=`egrep "ARG.*IMAGE_VERSION" Dockerfile | sed -e 's;^.*=;;' | head -1` && \
	IMAGE_RELEASE=`egrep "ARG.*IMAGE_RELEASE" Dockerfile | sed -e 's;^.*=;;' | head -1` && \
	IMAGE_ALIAS=`egrep "ARG.*IMAGE_ALIAS" Dockerfile | sed -e 's;^.*=;;' | head -1` && \
	docker buildx build \
	    --progress plain \
        --pull \
        --no-cache \
	    --platform linux/amd64,linux/arm64 \
	    -t $IMAGE_PREFIX$IMAGE_NAME:$IMAGE_ALIAS \
	    -t $IMAGE_PREFIX$IMAGE_NAME:$IMAGE_VERSION \
	    -t $IMAGE_PREFIX$IMAGE_NAME:$IMAGE_VERSION-$IMAGE_RELEASE \
	    -f Dockerfile . && \
	docker image ls $IMAGE_PREFIX$IMAGE_NAME:$IMAGE_VERSION-$IMAGE_RELEASE

#   package as Single Excecutable Application (SEA)
package:sea [hostname=en4.*]
    rm -rf dst-stage3 && \
    mkdir dst-stage3 && \
    cd dst-stage3 && \
    VERSION=`sed -n '/"version":/ s/.*: *"\(.*\)".*/\1/p' ../package.json` && \
    targets="node24-linux-x64,node24-linux-arm64" && \
    targets="$targets,node24-win-x64,node24-win-arm64" && \
    targets="$targets,node24-macos-x64,node24-macos-arm64" && \
    sed -e 's;@rse/nunjucks-cli;nunjucks;' -e '/"type"/d' <../package.json >package.json && \
    cp ../dst-stage2/nunjucks.cjs nunjucks.cjs && \
    cp ../dst-stage1/nunjucks.man nunjucks.man && \
    pkg --public --no-bytecode -c package.json -t "$targets" nunjucks.cjs && \
    shx mv nunjucks-linux-x64     nunjucks-lnx-x64     && \
    shx mv nunjucks-linux-arm64   nunjucks-lnx-a64     && \
    shx mv nunjucks-win-x64.exe   nunjucks-win-x64.exe && \
    shx mv nunjucks-win-arm64.exe nunjucks-win-a64.exe && \
    shx mv nunjucks-macos-x64     nunjucks-mac-x64     && \
    shx mv nunjucks-macos-arm64   nunjucks-mac-a64
    mkdir -p nunjucks-$VERSION/ && \
    mkdir -p nunjucks-$VERSION-win-x64/ && \
    mkdir -p nunjucks-$VERSION-win-a64/ && \
    mkdir -p nunjucks-$VERSION-mac-x64/ && \
    mkdir -p nunjucks-$VERSION-mac-a64/ && \
    mkdir -p nunjucks-$VERSION-lnx-x64/ && \
    mkdir -p nunjucks-$VERSION-lnx-a64/ && \
    cp -p nunjucks.cjs            nunjucks-$VERSION/nunjucks.cjs && \
    cp -p nunjucks-win-x64.exe    nunjucks-$VERSION-win-x64/nunjucks.exe && \
    cp -p nunjucks-win-a64.exe    nunjucks-$VERSION-win-a64/nunjucks.exe && \
    cp -p nunjucks-mac-x64        nunjucks-$VERSION-mac-x64/nunjucks && \
    cp -p nunjucks-mac-a64        nunjucks-$VERSION-mac-a64/nunjucks && \
    cp -p nunjucks-lnx-x64        nunjucks-$VERSION-lnx-x64/nunjucks && \
    cp -p nunjucks-lnx-a64        nunjucks-$VERSION-lnx-a64/nunjucks && \
    cp -p nunjucks.man            nunjucks-$VERSION/nunjucks.man && \
    cp -p nunjucks.man            nunjucks-$VERSION-win-x64/nunjucks.man && \
    cp -p nunjucks.man            nunjucks-$VERSION-win-a64/nunjucks.man && \
    cp -p nunjucks.man            nunjucks-$VERSION-mac-x64/nunjucks.man && \
    cp -p nunjucks.man            nunjucks-$VERSION-mac-a64/nunjucks.man && \
    cp -p nunjucks.man            nunjucks-$VERSION-lnx-x64/nunjucks.man && \
    cp -p nunjucks.man            nunjucks-$VERSION-lnx-a64/nunjucks.man && \
    zip -9 -r nunjucks-$VERSION.zip         nunjucks-$VERSION/         && \
    zip -9 -r nunjucks-$VERSION-win-x64.zip nunjucks-$VERSION-win-x64/ && \
    zip -9 -r nunjucks-$VERSION-win-a64.zip nunjucks-$VERSION-win-a64/ && \
    zip -9 -r nunjucks-$VERSION-mac-x64.zip nunjucks-$VERSION-mac-x64/ && \
    zip -9 -r nunjucks-$VERSION-mac-a64.zip nunjucks-$VERSION-mac-a64/ && \
    zip -9 -r nunjucks-$VERSION-lnx-x64.zip nunjucks-$VERSION-lnx-x64/ && \
    zip -9 -r nunjucks-$VERSION-lnx-a64.zip nunjucks-$VERSION-lnx-a64/

#   publish distribution archives
publish : publish:docker publish:sea [hostname=en4.*]

#   publish Docker container image
publish:docker [hostname=en4.*]
	IMAGE_PREFIX=`egrep "ARG.*IMAGE_PREFIX" Dockerfile | sed -e 's;^.*=;;' | head -1` && \
	IMAGE_NAME=`egrep "ARG.*IMAGE_NAME" Dockerfile | sed -e 's;^.*=;;' | head -1` && \
	IMAGE_VERSION=`egrep "ARG.*IMAGE_VERSION" Dockerfile | sed -e 's;^.*=;;' | head -1` && \
	IMAGE_RELEASE=`egrep "ARG.*IMAGE_RELEASE" Dockerfile | sed -e 's;^.*=;;' | head -1` && \
	IMAGE_ALIAS=`egrep "ARG.*IMAGE_ALIAS" Dockerfile | sed -e 's;^.*=;;' | head -1` && \
	docker push $IMAGE_PREFIX$IMAGE_NAME:$IMAGE_VERSION-$IMAGE_RELEASE && \
	docker push $IMAGE_PREFIX$IMAGE_NAME:$IMAGE_VERSION && \
	docker push $IMAGE_PREFIX$IMAGE_NAME:$IMAGE_ALIAS

#   publish Single Excecutable Application (SEA)
publish:sea [hostname=en4.*]
    VERSION=`sed -n '/"version":/ s/.*: *"\(.*\)".*/\1/p' package.json` && \
    V=`echo "$VERSION" | sed -e 's;\.;\\.;g'` && \
    sed -n -e "/^${V} /, /^[0-9]\\./ { /^${V} /p; /^[0-9]\\./!p; }" <CHANGELOG.md >.notes.md && \
    gh release create --title "Nunjucks $VERSION" --notes-file .notes.md --verify-tag $VERSION \
    dst-stage3/nunjucks-$VERSION.zip \
    dst-stage3/nunjucks-$VERSION-win-x64.zip \
    dst-stage3/nunjucks-$VERSION-win-a64.zip \
    dst-stage3/nunjucks-$VERSION-mac-x64.zip \
    dst-stage3/nunjucks-$VERSION-mac-a64.zip \
    dst-stage3/nunjucks-$VERSION-lnx-x64.zip \
    dst-stage3/nunjucks-$VERSION-lnx-a64.zip && \
    rm -f .notes.md

#   remove all generated artifacts
clean
    shx rm -rf dst-stage*

#   remove all generated artifacts
distclean: clean
    shx rm -f package-lock.json && \
    shx rm -rf node_modules

