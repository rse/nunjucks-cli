##
##  nunjucks -- Nunjucks Template Rendering Command-Line Interface
##  Copyright (c) 2019-2025 Dr. Ralf S. Engelschall <rse@engelschall.com>
##  Licensed under MIT <https://spdx.org/licenses/MIT>
##

#   static code analysis
lint
    eslint --config eslint.mjs nunjucks.ts && \
    tsc --project tsconfig.json

#   build manual page
man
    remark --quiet --use remark-man --output nunjucks.1 nunjucks.md

#   execute simple smole test
test
    echo 'Hello, {{who}}!' | node nunjucks.ts -D who=world -

#   build all-in-one packages
build:pkg [hostname=en4.*]

#   package distribution archives
package : build:pkg [hostname=en4.*]
    VERSION=`sed -n '/"version":/ s/.*: *"\(.*\)".*/\1/p' package.json` && \
    targets="node24-linux-x64,node24-linux-arm64" && \
    targets="$targets,node24-win-x64,node24-win-arm64" && \
    targets="$targets,node24-macos-x64,node24-macos-arm64" && \
    sed -e 's;@rse/nunjucks-cli;nunjucks;' <package.json >nunjucks.json && \
    pkg --sea --public -c nunjucks.json -t "$targets" nunjucks.ts && \
    rm -f nunjucks.json && \
    shx mv nunjucks-linux-x64     nunjucks-lnx-x64     && \
    shx mv nunjucks-linux-arm64   nunjucks-lnx-a64     && \
    shx mv nunjucks-win-x64.exe   nunjucks-win-x64.exe && \
    shx mv nunjucks-win-arm64.exe nunjucks-win-a64.exe && \
    shx mv nunjucks-macos-x64     nunjucks-mac-x64     && \
    shx mv nunjucks-macos-arm64   nunjucks-mac-a64
    mkdir -p nunjucks-$VERSION/ && \
    mkdir -p nunjucks-$VERSION-win-x64/ && \
    mkdir -p nunjucks-$VERSION-win-a64/ && \
    mkdir -p nunjucks-$VERSION-mac-x64/ && \
    mkdir -p nunjucks-$VERSION-mac-a64/ && \
    mkdir -p nunjucks-$VERSION-lnx-x64/ && \
    mkdir -p nunjucks-$VERSION-lnx-a64/ && \
    cp -p nunjucks.ts             nunjucks-$VERSION/nunjucks.ts && \
    cp -p nunjucks-win-x64.exe    nunjucks-$VERSION-win-x64/nunjucks.exe && \
    cp -p nunjucks-win-a64.exe    nunjucks-$VERSION-win-a64/nunjucks.exe && \
    cp -p nunjucks-mac-x64        nunjucks-$VERSION-mac-x64/nunjucks && \
    cp -p nunjucks-mac-a64        nunjucks-$VERSION-mac-a64/nunjucks && \
    cp -p nunjucks-lnx-x64        nunjucks-$VERSION-lnx-x64/nunjucks && \
    cp -p nunjucks-lnx-a64        nunjucks-$VERSION-lnx-a64/nunjucks && \
    cp -p nunjucks.1              nunjucks-$VERSION/nunjucks.man && \
    cp -p nunjucks.1              nunjucks-$VERSION-win-x64/nunjucks.man && \
    cp -p nunjucks.1              nunjucks-$VERSION-win-a64/nunjucks.man && \
    cp -p nunjucks.1              nunjucks-$VERSION-mac-x64/nunjucks.man && \
    cp -p nunjucks.1              nunjucks-$VERSION-mac-a64/nunjucks.man && \
    cp -p nunjucks.1              nunjucks-$VERSION-lnx-x64/nunjucks.man && \
    cp -p nunjucks.1              nunjucks-$VERSION-lnx-a64/nunjucks.man && \
    zip -9 -r nunjucks-$VERSION.zip         nunjucks-$VERSION/         && \
    zip -9 -r nunjucks-$VERSION-win-x64.zip nunjucks-$VERSION-win-x64/ && \
    zip -9 -r nunjucks-$VERSION-win-a64.zip nunjucks-$VERSION-win-a64/ && \
    zip -9 -r nunjucks-$VERSION-mac-x64.zip nunjucks-$VERSION-mac-x64/ && \
    zip -9 -r nunjucks-$VERSION-mac-a64.zip nunjucks-$VERSION-mac-a64/ && \
    zip -9 -r nunjucks-$VERSION-lnx-x64.zip nunjucks-$VERSION-lnx-x64/ && \
    zip -9 -r nunjucks-$VERSION-lnx-a64.zip nunjucks-$VERSION-lnx-a64/

#   publish distribution archives
publish : package [hostname=en4.*]
    VERSION=`sed -n '/"version":/ s/.*: *"\(.*\)".*/\1/p' package.json` && \
    V=`echo "$VERSION" | sed -e 's;\.;\\.;g'` && \
    sed -n -e "/^${V} /, /^[0-9]\\./ { /^${V} /p; /^[0-9]\\./!p; }" <CHANGELOG.md >.notes.md && \
    gh release create --title "Nunjucks $VERSION" --notes-file .notes.md --verify-tag $VERSION \
    nunjucks-$VERSION.zip \
    nunjucks-$VERSION-win-x64.zip \
    nunjucks-$VERSION-win-a64.zip \
    nunjucks-$VERSION-mac-x64.zip \
    nunjucks-$VERSION-mac-a64.zip \
    nunjucks-$VERSION-lnx-x64.zip \
    nunjucks-$VERSION-lnx-a64.zip && \
    rm -f .notes.md

#   remove all generated artifacts
clean
    shx rm -rf nunjucks-*.zip

#   remove all generated artifacts
clean:dist : clean
    shx rm -f package-lock.json && \
    shx rm -rf node_modules

